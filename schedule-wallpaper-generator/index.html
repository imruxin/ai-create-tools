<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä½œæ¯å£çº¸ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Tailwind é…ç½® -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#3B82F6",
              secondary: "#10B981",
              accent: "#8B5CF6",
              neutral: "#1F2937",
              "base-100": "#FFFFFF",
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>

    <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
        .wallpaper-preview {
          background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .grid-mask {
          background-size: 20px 20px;
          background-image: linear-gradient(
              to right,
              rgba(0, 0, 0, 0.05) 1px,
              transparent 1px
            ),
            linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
        }
        .time-block-card {
          backdrop-filter: blur(8px);
          background-color: rgba(255, 255, 255, 0.7);
        }
        .timeline-item {
          position: relative;
          padding-left: 2rem;
        }
        .timeline-item::before {
          content: "";
          position: absolute;
          left: 0.5rem;
          top: 0;
          bottom: 0;
          width: 2px;
          background-color: currentColor;
        }
        .timeline-dot {
          position: absolute;
          left: 0;
          top: 0.5rem;
          width: 1rem;
          height: 1rem;
          border-radius: 50%;
          background-color: currentColor;
        }
        .loading-spinner {
          border: 2px solid #f3f3f3;
          border-top: 2px solid #3498db;
          border-radius: 50%;
          width: 20px;
          height: 20px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }
        .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 1000;
          min-width: 300px;
          max-width: 500px;
          padding: 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          transform: translateX(100%);
          transition: transform 0.3s ease-in-out;
        }
        .notification.show {
          transform: translateX(0);
        }
        .notification.success {
          background-color: #10b981;
          color: white;
        }
        .notification.error {
          background-color: #ef4444;
          color: white;
        }
        .notification.warning {
          background-color: #f59e0b;
          color: white;
        }
        .notification.info {
          background-color: #3b82f6;
          color: white;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans">
    <main class="container mx-auto px-4 py-8">
      <!-- åŠŸèƒ½ä»‹ç»æ¨ªå¹… -->
      <div
        class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-6 mb-8 shadow-lg"
      >
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold mb-2">ğŸ¨ æ—¶é—´è§„åˆ’å£çº¸ç”Ÿæˆå™¨</h2>
            <p class="text-blue-100">
              åˆ›å»ºä¸ªæ€§åŒ–çš„ä½œæ¯æ—¶é—´è¡¨å£çº¸ï¼Œè®©æ—¶é—´ç®¡ç†æ›´åŠ ç›´è§‚å’Œç¾è§‚
            </p>
          </div>
          <div class="hidden md:block">
            <div class="flex space-x-4 text-sm">
              <div class="text-center">
                <div class="text-2xl font-bold">4</div>
                <div class="text-blue-200">å¸ƒå±€é€‰é¡¹</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold">12</div>
                <div class="text-blue-200">é¢œè‰²ä¸»é¢˜</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold">âˆ</div>
                <div class="text-blue-200">è‡ªå®šä¹‰</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- å·¦ä¾§ï¼šæ•°æ®è¾“å…¥åŒºåŸŸ -->
        <div class="lg:col-span-3 bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-lg font-semibold text-neutral mb-4 flex items-center">
            <i class="fa fa-list-alt text-primary mr-2"></i>è¾“å…¥ä½œæ¯æ•°æ®
          </h2>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >é€‰æ‹©è¾“å…¥æ–¹å¼</label
            >
            <div class="flex space-x-4">
              <button
                id="manualInputBtn"
                class="flex-1 py-2 px-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
              >
                <i class="fa fa-keyboard-o mr-1"></i> æ‰‹åŠ¨è¾“å…¥
              </button>
              <button
                id="uploadFileBtn"
                class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
              >
                <i class="fa fa-upload mr-1"></i> ä¸Šä¼ æ–‡ä»¶
              </button>
            </div>
          </div>

          <!-- æ‰‹åŠ¨è¾“å…¥è¡¨å• -->
          <div id="manualInputForm" class="space-y-4">
            <div class="mb-4">
              <label
                for="title"
                class="block text-sm font-medium text-gray-700 mb-1"
                >å£çº¸æ ‡é¢˜</label
              >
              <input
                type="text"
                id="title"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                placeholder="æˆ‘çš„ä½œæ¯è¡¨"
              />
            </div>

            <div class="mb-4">
              <label
                for="subtitle"
                class="block text-sm font-medium text-gray-700 mb-1"
                >å‰¯æ ‡é¢˜</label
              >
              <input
                type="text"
                id="subtitle"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                placeholder="ä¿æŒè§„å¾‹ï¼Œæå‡æ•ˆç‡"
              />
              <div class="mt-2 flex items-center">
                <input
                  type="checkbox"
                  id="hideSubtitle"
                  class="mr-2 rounded border-gray-300 text-primary focus:ring-primary"
                />
                <label for="hideSubtitle" class="text-sm text-gray-600">
                  éšè—å‰¯æ ‡é¢˜
                </label>
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >æ·»åŠ æ—¶é—´æ®µ</label
              >
              <div class="time-block grid grid-cols-2 gap-3 mb-2">
                <div>
                  <input
                    type="time"
                    class="start-time w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                  />
                </div>
                <div>
                  <input
                    type="time"
                    class="end-time w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                  />
                </div>
              </div>
              <div>
                <input
                  type="text"
                  class="activity w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                  placeholder="æ´»åŠ¨æè¿°"
                />
              </div>
              <button
                id="addTimeBtn"
                class="mt-2 w-full py-2 px-4 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors flex justify-center items-center"
              >
                <i class="fa fa-plus mr-1"></i> æ·»åŠ æ—¶é—´æ®µ
              </button>
            </div>

            <div class="border-t border-gray-200 pt-4">
              <button
                id="updatePreviewBtn"
                class="w-full py-2 px-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex justify-center items-center"
              >
                <i class="fa fa-refresh mr-1"></i> æ›´æ–°é¢„è§ˆ
              </button>
            </div>
          </div>

          <!-- ä¸Šä¼ æ–‡ä»¶è¡¨å• (é»˜è®¤éšè—) -->
          <div id="uploadFileForm" class="hidden space-y-4">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >æ”¯æŒçš„æ ¼å¼: CSV, XLSX</label
              >
              <div class="relative">
                <div class="flex items-center justify-center w-full">
                  <label
                    for="file-upload"
                    class="flex flex-col items-center justify-center w-full h-40 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors"
                  >
                    <div
                      class="flex flex-col items-center justify-center pt-5 pb-6"
                    >
                      <i
                        class="fa fa-cloud-upload text-4xl text-gray-400 mb-2"
                      ></i>
                      <p class="mb-2 text-sm text-gray-500">
                        <span class="font-semibold">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</span> æˆ–æ‹–æ”¾
                      </p>
                      <p class="text-xs text-gray-500">æ”¯æŒ CSV, XLSX</p>
                    </div>
                    <input
                      id="file-upload"
                      type="file"
                      class="hidden"
                      accept=".csv,.xlsx,.xls"
                    />
                  </label>
                </div>
              </div>
            </div>

            <div class="border-t border-gray-200 pt-4 flex space-x-2">
              <button
                id="parseFileBtn"
                class="flex-1 py-2 px-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex justify-center items-center"
              >
                <i class="fa fa-refresh mr-1"></i> è§£ææ–‡ä»¶
              </button>
              <button
                id="downloadTemplateBtn"
                class="flex-1 py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex justify-center items-center"
              >
                <i class="fa fa-download mr-1"></i> ä¸‹è½½æ¨¡æ¿
              </button>
            </div>
          </div>

          <!-- å·²æ·»åŠ çš„æ—¶é—´æ®µåˆ—è¡¨ -->
          <div class="mt-8">
            <h3
              class="text-md font-semibold text-neutral mb-3 flex items-center justify-between"
            >
              <span>å·²æ·»åŠ çš„æ—¶é—´æ®µ</span>
              <span id="scheduleCount" class="text-sm text-gray-500">(0)</span>
            </h3>
            <div id="scheduleList" class="space-y-2 max-h-64 overflow-y-auto">
              <!-- æ—¶é—´æ®µåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>

          <!-- é¢„è®¾æ¨¡æ¿ -->
          <div class="mt-8">
            <h3 class="text-md font-semibold text-neutral mb-3">å¿«é€Ÿæ¨¡æ¿</h3>
            <div class="grid grid-cols-2 gap-2">
              <button
                class="template-btn py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-sm text-center"
                data-template="student"
              >
                å­¦ç”Ÿæ—¥å¸¸
              </button>
              <button
                class="template-btn py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-sm text-center"
                data-template="office"
              >
                èŒåœºç™½é¢†
              </button>
              <button
                class="template-btn py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-sm text-center"
                data-template="freelancer"
              >
                è‡ªç”±èŒä¸šè€…
              </button>
              <button
                class="template-btn py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-sm text-center"
                data-template="fitness"
              >
                å¥èº«è®¡åˆ’
              </button>
            </div>
          </div>
        </div>

        <!-- ä¸­é—´ï¼šé¢„è§ˆåŒºåŸŸ -->
        <div class="lg:col-span-6">
          <div class="bg-white rounded-xl shadow-lg p-6 h-full">
            <h2
              class="text-lg font-semibold text-neutral mb-4 flex items-center"
            >
              <i class="fa fa-eye text-primary mr-2"></i>å£çº¸é¢„è§ˆ
            </h2>

            <div
              class="relative aspect-[16/9] bg-gray-100 rounded-lg overflow-hidden grid-mask"
            >
              <div
                id="wallpaperPreview"
                class="wallpaper-preview absolute inset-0 flex flex-col p-8"
              >
                <!-- å£çº¸å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                <div class="text-center mb-8">
                  <h2
                    id="previewTitle"
                    class="text-4xl font-bold text-neutral mb-2"
                  >
                    æˆ‘çš„ä½œæ¯è¡¨
                  </h2>
                  <p id="previewSubtitle" class="text-gray-600">
                    ä¿æŒè§„å¾‹ï¼Œæå‡æ•ˆç‡
                  </p>
                </div>

                <div
                  id="scheduleContainer"
                  class="grid grid-cols-2 gap-4 h-full"
                >
                  <!-- æ—¶é—´æ®µå†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row justify-center gap-4">
              <button
                id="downloadBtn"
                class="py-3 px-6 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center"
              >
                <i class="fa fa-download mr-2"></i> ä¸‹è½½å£çº¸
              </button>
              <button
                id="fullscreenBtn"
                class="py-3 px-6 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors flex items-center justify-center"
              >
                <i class="fa fa-expand mr-2"></i> å…¨å±é¢„è§ˆ
              </button>
            </div>

            <!-- ä½¿ç”¨æç¤º -->
            <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
              <h4
                class="text-sm font-semibold text-blue-800 mb-2 flex items-center"
              >
                <i class="fa fa-lightbulb-o mr-2"></i>ä½¿ç”¨æç¤º
              </h4>
              <ul class="text-sm text-blue-700 space-y-1">
                <li>â€¢ ç‚¹å‡»å·¦ä¾§æ—¶é—´æ®µåˆ—è¡¨ä¸­çš„ç¼–è¾‘æŒ‰é’®å¯ä¿®æ”¹å·²æ·»åŠ çš„æ—¶é—´æ®µ</li>
                <li>â€¢ é€‰æ‹©ä¸åŒçš„å¸ƒå±€æ–¹å¼æ¥æ”¹å˜å£çº¸å±•ç¤ºæ•ˆæœ</li>
                <li>â€¢ èƒŒæ™¯é¢œè‰²ä¼šè¦†ç›–é»˜è®¤æ¸å˜ï¼Œé€‰æ‹©é€æ˜å¯æ¢å¤é»˜è®¤æ¸å˜æ•ˆæœ</li>
                <li>â€¢ æ”¯æŒCSVå’ŒExcelæ–‡ä»¶å¯¼å…¥ï¼Œå¯ä¸‹è½½æ¨¡æ¿æ–‡ä»¶å‚è€ƒæ ¼å¼</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šæ ·å¼è®¾ç½®åŒºåŸŸ -->
        <div class="lg:col-span-3 bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-lg font-semibold text-neutral mb-4 flex items-center">
            <i class="fa fa-paint-brush text-primary mr-2"></i>æ ·å¼è®¾ç½®
          </h2>

          <!-- å¸ƒå±€é€‰æ‹© -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >é€‰æ‹©å¸ƒå±€</label
            >
            <div class="space-y-2">
              <label
                class="flex items-center p-3 border rounded-lg hover:bg-gray-50 transition-colors"
              >
                <input
                  type="radio"
                  name="layout"
                  class="mr-2"
                  value="time-block"
                  checked
                />
                <span>æŒ‰æ—¶é—´æ®µåˆ’åˆ†</span>
              </label>
              <label
                class="flex items-center p-3 border rounded-lg hover:bg-gray-50 transition-colors"
              >
                <input
                  type="radio"
                  name="layout"
                  class="mr-2"
                  value="timeline"
                />
                <span>æ—¶é—´è½´å¸ƒå±€</span>
              </label>
              <label
                class="flex items-center p-3 border rounded-lg hover:bg-gray-50 transition-colors"
              >
                <input type="radio" name="layout" class="mr-2" value="grid" />
                <span>ç½‘æ ¼å¸ƒå±€</span>
              </label>
              <label
                class="flex items-center p-3 border rounded-lg hover:bg-gray-50 transition-colors"
              >
                <input type="radio" name="layout" class="mr-2" value="table" />
                <span>è¡¨æ ¼å¸ƒå±€</span>
              </label>
            </div>

            <!-- è¡¨æ ¼å¸ƒå±€é…ç½® -->
            <div
              id="tableLayoutConfig"
              class="mt-4 p-3 bg-gray-50 rounded-lg hidden"
            >
              <label class="block text-sm font-medium text-gray-700 mb-2">
                è¡¨æ ¼åˆ—æ•°
              </label>
              <div class="flex space-x-2">
                <label class="flex items-center">
                  <input
                    type="radio"
                    name="tableColumns"
                    value="1"
                    class="mr-1"
                  />
                  <span class="text-sm">å•åˆ—</span>
                </label>
                <label class="flex items-center">
                  <input
                    type="radio"
                    name="tableColumns"
                    value="2"
                    class="mr-1"
                    checked
                  />
                  <span class="text-sm">åŒåˆ—</span>
                </label>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <div class="space-y-2"></div>
          </div>

          <!-- å­—ä½“è®¾ç½® -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >å­—ä½“è®¾ç½®</label
            >
            <select
              id="fontSelect"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary mb-3"
            >
              <option value="Inter">Inter (é»˜è®¤)</option>
              <option value="Roboto">Roboto</option>
              <option value="Montserrat">Montserrat</option>
              <option value="Open Sans">Open Sans</option>
            </select>

            <div class="flex items-center justify-between mb-2">
              <label class="text-sm text-gray-700">å­—ä½“å¤§å°</label>
              <span id="fontSizeValue" class="text-sm font-medium">16px</span>
            </div>
            <input
              id="fontSizeSlider"
              type="range"
              min="12"
              max="24"
              value="16"
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"
            />
          </div>

          <!-- é¢œè‰²è®¾ç½® -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >èƒŒæ™¯é¢œè‰²</label
            >
            <p class="text-xs text-gray-500 mb-3">
              é€‰æ‹©èƒŒæ™¯é¢œè‰²ä¼šè¦†ç›–é»˜è®¤æ¸å˜æ•ˆæœï¼Œé€‰æ‹©é€æ˜å¯æ¢å¤é»˜è®¤æ¸å˜
            </p>
            <div class="grid grid-cols-6 gap-2 mb-3">
              <button
                class="color-btn w-full h-8 rounded-full bg-blue-500 border-2 border-white hover:ring-2 hover:ring-blue-500 transition-all shadow-md"
                data-color="blue-500"
                title="è“è‰²"
              ></button>
              <button
                class="color-btn w-full h-8 rounded-full bg-green-500 border-2 border-white hover:ring-2 hover:ring-green-500 transition-all shadow-md"
                data-color="green-500"
                title="ç»¿è‰²"
              ></button>
              <button
                class="color-btn w-full h-8 rounded-full bg-purple-500 border-2 border-white hover:ring-2 hover:ring-purple-500 transition-all shadow-md"
                data-color="purple-500"
                title="ç´«è‰²"
              ></button>
              <button
                class="color-btn w-full h-8 rounded-full bg-yellow-500 border-2 border-white hover:ring-2 hover:ring-yellow-500 transition-all shadow-md"
                data-color="yellow-500"
                title="é»„è‰²"
              ></button>
              <button
                class="color-btn w-full h-8 rounded-full bg-red-500 border-2 border-white hover:ring-2 hover:ring-red-500 transition-all shadow-md"
                data-color="red-500"
                title="çº¢è‰²"
              ></button>
              <button
                class="color-btn w-full h-8 rounded-full bg-indigo-500 border-2 border-white hover:ring-2 hover:ring-indigo-500 transition-all shadow-md"
                data-color="indigo-500"
                title="é›è“"
              ></button>
            </div>
            <div class="grid grid-cols-6 gap-2">
              <button
                class="color-btn w-full h-8 rounded-full bg-teal-500 border-2 border-white hover:ring-2 hover:ring-teal-500 transition-all shadow-md"
                data-color="teal-500"
                title="é’è‰²"
              ></button>
              <button
                class="color-btn w-full h-8 rounded-full bg-pink-500 border-2 border-white hover:ring-2 hover:ring-pink-500 transition-all shadow-md"
                data-color="pink-500"
                title="ç²‰è‰²"
              ></button>
              <button
                class="color-btn w-full h-8 rounded-full bg-orange-500 border-2 border-white hover:ring-2 hover:ring-orange-500 transition-all shadow-md"
                data-color="orange-500"
                title="æ©™è‰²"
              ></button>
              <button
                class="color-btn w-full h-8 rounded-full bg-gray-800 border-2 border-white hover:ring-2 hover:ring-gray-800 transition-all shadow-md"
                data-color="gray-800"
                title="æ·±ç°"
              ></button>
              <button
                class="color-btn w-full h-8 rounded-full bg-white border-2 border-gray-300 hover:ring-2 hover:ring-gray-400 transition-all shadow-md"
                data-color="white"
                title="ç™½è‰²"
              ></button>
              <button
                class="color-btn w-full h-8 rounded-full border-2 border-gray-300 hover:ring-2 hover:ring-gray-400 transition-all shadow-md"
                data-color="transparent"
                title="é€æ˜ï¼ˆä½¿ç”¨é»˜è®¤æ¸å˜ï¼‰"
                style="
                  background: linear-gradient(
                      45deg,
                      #f0f0f0 25%,
                      transparent 25%
                    ),
                    linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                    linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
                  background-size: 8px 8px;
                  background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
                "
              ></button>
            </div>
          </div>

          <!-- é«˜çº§è®¾ç½® -->
          <div>
            <button
              id="advancedSettingsBtn"
              class="w-full py-2 text-left text-primary hover:text-primary/80 transition-colors flex items-center justify-between"
            >
              <span>é«˜çº§è®¾ç½®</span>
              <i class="fa fa-chevron-down text-xs"></i>
            </button>
            <div id="advancedSettingsPanel" class="hidden mt-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >å£çº¸åˆ†è¾¨ç‡</label
                >
                <select
                  id="resolutionSelect"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                >
                  <option value="1920x1080">1920 x 1080 (Full HD)</option>
                  <option value="2560x1440">2560 x 1440 (QHD)</option>
                  <option value="3840x2160">3840 x 2160 (4K)</option>
                  <option value="custom">è‡ªå®šä¹‰</option>
                </select>
              </div>
              <div id="customResolutionInputs" class="hidden space-y-2">
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >å®½åº¦ (px)</label
                    >
                    <input
                      id="customWidth"
                      type="number"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                      placeholder="1920"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >é«˜åº¦ (px)</label
                    >
                    <input
                      id="customHeight"
                      type="number"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                      placeholder="1080"
                    />
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >æ·»åŠ èƒŒæ™¯å›¾ç‰‡</label
                >
                <input
                  id="bgImageUpload"
                  type="file"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                  accept="image/*"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-12">
      <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="mb-4 md:mb-0">
            <p class="text-gray-500 text-sm">
              Â© 2025 æ—¶é—´è§„åˆ’ä½œæ¯å£çº¸ç”Ÿæˆå™¨. ä¿ç•™æ‰€æœ‰æƒåˆ©.
            </p>
          </div>
          <div class="flex space-x-4">
            <a
              href="https://www.imruxin.com"
              class="text-gray-400 hover:text-primary transition-colors"
            >
              <i class="fa fa-user text-xl"></i>
            </a>
          </div>
        </div>
      </div>
    </footer>

    <script>
      // å­˜å‚¨ç”¨æˆ·æ•°æ®
      const userData = {
        title: "æˆ‘çš„ä½œæ¯è¡¨",
        subtitle: "ä¿æŒè§„å¾‹ï¼Œæå‡æ•ˆç‡",
        hideSubtitle: false,
        schedule: [
          {
            id: 1,
            startTime: "07:00",
            endTime: "08:00",
            activity: "èµ·åºŠ & æ—©é¤",
          },
          {
            id: 2,
            startTime: "08:00",
            endTime: "10:00",
            activity: "å·¥ä½œ/å­¦ä¹ ",
          },
          { id: 3, startTime: "10:00", endTime: "10:15", activity: "ä¼‘æ¯" },
          {
            id: 4,
            startTime: "13:00",
            endTime: "15:00",
            activity: "å·¥ä½œ/å­¦ä¹ ",
          },
          { id: 5, startTime: "15:00", endTime: "15:15", activity: "ä¸‹åˆèŒ¶" },
          {
            id: 6,
            startTime: "15:15",
            endTime: "18:00",
            activity: "å·¥ä½œ/å­¦ä¹ ",
          },
          { id: 7, startTime: "18:00", endTime: "19:00", activity: "æ™šé¤" },
          {
            id: 8,
            startTime: "19:00",
            endTime: "20:30",
            activity: "ä¼‘é—²/è¿åŠ¨",
          },
          { id: 9, startTime: "20:30", endTime: "22:00", activity: "è‡ªç”±æ—¶é—´" },
          {
            id: 10,
            startTime: "22:00",
            endTime: "23:00",
            activity: "å‡†å¤‡ç¡è§‰",
          },
          { id: 11, startTime: "23:00", endTime: "07:00", activity: "ç¡çœ " },
        ],
        layout: "time-block",
        fontSize: 16,
        fontFamily: "Inter",
        bgColor: "transparent",
        resolution: "1920x1080",
        customWidth: 1920,
        customHeight: 1080,
        tableColumns: 2, // è¡¨æ ¼åˆ—æ•°é…ç½®
      };

      // ç¼–è¾‘çŠ¶æ€ç®¡ç†
      let editingScheduleId = null;
      let nextScheduleId = 12;

      /**
       * æ ‡å‡†åŒ–æ—¶é—´æ ¼å¼
       * å°† "7:00" è½¬æ¢ä¸º "07:00"ï¼Œç¡®ä¿æ—¶é—´æ ¼å¼ä¸€è‡´
       * @param {string} timeStr - æ—¶é—´å­—ç¬¦ä¸²
       * @returns {string} - æ ‡å‡†åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸² (HH:MM)
       */
      function normalizeTime(timeStr) {
        if (!timeStr) return "00:00";

        const [hours, minutes] = timeStr.split(":");
        const normalizedHours = hours.padStart(2, "0");
        const normalizedMinutes = (minutes || "00").padStart(2, "0");

        return `${normalizedHours}:${normalizedMinutes}`;
      }

      /**
       * æ ‡å‡†åŒ–Excelæ—¶é—´æ ¼å¼
       * å¤„ç†Excelå¯èƒ½çš„å„ç§æ—¶é—´æ ¼å¼ï¼ŒåŒ…æ‹¬æ•°å­—æ ¼å¼å’Œæ–‡æœ¬æ ¼å¼
       * @param {string|number} timeValue - Excelä¸­çš„æ—¶é—´å€¼
       * @returns {string} - æ ‡å‡†åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸² (HH:MM)
       */
      function normalizeExcelTime(timeValue) {
        if (!timeValue && timeValue !== 0) return "00:00";

        // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
        let timeStr = timeValue.toString().trim();

        // å¦‚æœæ˜¯æ•°å­—æ ¼å¼ï¼ˆExcelçš„æ—¶é—´åºåˆ—å€¼ï¼‰
        if (!isNaN(timeValue) && timeValue >= 0 && timeValue <= 1) {
          // Excelæ—¶é—´æ˜¯ä»¥å¤©ä¸ºå•ä½çš„å°æ•°ï¼Œéœ€è¦è½¬æ¢ä¸ºå°æ—¶:åˆ†é’Ÿ
          const totalMinutes = Math.round(timeValue * 24 * 60);
          const hours = Math.floor(totalMinutes / 60);
          const minutes = totalMinutes % 60;
          return `${hours.toString().padStart(2, "0")}:${minutes
            .toString()
            .padStart(2, "0")}`;
        }

        // å¤„ç†å¸¸è§çš„æ—¶é—´æ ¼å¼
        // ç§»é™¤å¯èƒ½çš„AM/PMæ ‡è®°
        timeStr = timeStr.replace(/\s*(AM|PM|ä¸Šåˆ|ä¸‹åˆ)\s*/gi, "");

        // å¤„ç† "7:00" æˆ– "07:00" æ ¼å¼
        if (timeStr.includes(":")) {
          const parts = timeStr.split(":");
          if (parts.length >= 2) {
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            return `${hours.toString().padStart(2, "0")}:${minutes
              .toString()
              .padStart(2, "0")}`;
          }
        }

        // å¤„ç†çº¯æ•°å­—æ ¼å¼ï¼ˆå¦‚ "700" è¡¨ç¤º "7:00"ï¼‰
        if (/^\d{3,4}$/.test(timeStr)) {
          if (timeStr.length === 3) {
            // "700" -> "7:00"
            const hours = parseInt(timeStr.substring(0, 1));
            const minutes = parseInt(timeStr.substring(1, 3));
            return `${hours.toString().padStart(2, "0")}:${minutes
              .toString()
              .padStart(2, "0")}`;
          } else if (timeStr.length === 4) {
            // "1430" -> "14:30"
            const hours = parseInt(timeStr.substring(0, 2));
            const minutes = parseInt(timeStr.substring(2, 4));
            return `${hours.toString().padStart(2, "0")}:${minutes
              .toString()
              .padStart(2, "0")}`;
          }
        }

        // å¤„ç†å•ç‹¬çš„å°æ—¶æ•°ï¼ˆå¦‚ "7" è¡¨ç¤º "7:00"ï¼‰
        if (/^\d{1,2}$/.test(timeStr)) {
          const hours = parseInt(timeStr);
          if (hours >= 0 && hours <= 23) {
            return `${hours.toString().padStart(2, "0")}:00`;
          }
        }

        // å¦‚æœéƒ½ä¸åŒ¹é…ï¼Œå°è¯•ä½¿ç”¨åŸå§‹çš„normalizeTimeå‡½æ•°
        return normalizeTime(timeStr);
      }

      /**
       * æ—¶é—´æ’åºå‡½æ•°
       * å°†æ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆ†é’Ÿæ•°è¿›è¡Œæ¯”è¾ƒï¼Œæ­£ç¡®å¤„ç†è·¨å¤©æƒ…å†µ
       * @param {string} timeStr - æ—¶é—´å­—ç¬¦ä¸² (HH:MM æˆ– H:MM)
       * @returns {number} - åˆ†é’Ÿæ•°
       */
      function timeToMinutes(timeStr) {
        const normalizedTime = normalizeTime(timeStr);
        const [hours, minutes] = normalizedTime.split(":").map(Number);
        return hours * 60 + minutes;
      }

      /**
       * æ™ºèƒ½æ—¶é—´æ’åºå‡½æ•°
       * è€ƒè™‘è·¨å¤©æƒ…å†µçš„æ—¶é—´æ’åº
       * @param {Array} schedule - æ—¶é—´è¡¨æ•°ç»„
       * @returns {Array} - æ’åºåçš„æ—¶é—´è¡¨
       */
      function sortScheduleByTime(schedule) {
        return [...schedule].sort((a, b) => {
          const aStart = timeToMinutes(a.startTime);
          const bStart = timeToMinutes(b.startTime);

          // å¦‚æœå¼€å§‹æ—¶é—´ç›¸åŒï¼ŒæŒ‰ç»“æŸæ—¶é—´æ’åº
          if (aStart === bStart) {
            const aEnd = timeToMinutes(a.endTime);
            const bEnd = timeToMinutes(b.endTime);

            // å¤„ç†è·¨å¤©æƒ…å†µ
            const aEndAdjusted = aEnd < aStart ? aEnd + 24 * 60 : aEnd;
            const bEndAdjusted = bEnd < bStart ? bEnd + 24 * 60 : bEnd;

            return aEndAdjusted - bEndAdjusted;
          }

          return aStart - bStart;
        });
      }

      // é¡µé¢äº¤äº’é€»è¾‘
      document.addEventListener("DOMContentLoaded", function () {
        // æ‰‹åŠ¨è¾“å…¥å’Œä¸Šä¼ æ–‡ä»¶åˆ‡æ¢
        const manualInputBtn = document.getElementById("manualInputBtn");
        const uploadFileBtn = document.getElementById("uploadFileBtn");
        const manualInputForm = document.getElementById("manualInputForm");
        const uploadFileForm = document.getElementById("uploadFileForm");

        manualInputBtn.addEventListener("click", function () {
          manualInputBtn.classList.remove("bg-gray-200", "text-gray-700");
          manualInputBtn.classList.add("bg-primary", "text-white");

          uploadFileBtn.classList.remove("bg-primary", "text-white");
          uploadFileBtn.classList.add("bg-gray-200", "text-gray-700");

          manualInputForm.classList.remove("hidden");
          uploadFileForm.classList.add("hidden");
        });

        uploadFileBtn.addEventListener("click", function () {
          uploadFileBtn.classList.remove("bg-gray-200", "text-gray-700");
          uploadFileBtn.classList.add("bg-primary", "text-white");

          manualInputBtn.classList.remove("bg-primary", "text-white");
          manualInputBtn.classList.add("bg-gray-200", "text-gray-700");

          uploadFileForm.classList.remove("hidden");
          manualInputForm.classList.add("hidden");
        });

        /**
         * å®ç°æ—¶é—´æ®µæ·»åŠ /ç¼–è¾‘åŠŸèƒ½
         * æ”¯æŒæ–°å¢æ—¶é—´æ®µå’Œç¼–è¾‘ç°æœ‰æ—¶é—´æ®µ
         */
        const addTimeBtn = document.getElementById("addTimeBtn");
        addTimeBtn.addEventListener("click", function () {
          const startTimeInput = document.querySelector(".start-time");
          const endTimeInput = document.querySelector(".end-time");
          const activityInput = document.querySelector(".activity");

          // æ—¶é—´æ ¼å¼éªŒè¯ (HH:MM)
          const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
          if (!timeRegex.test(startTimeInput.value)) {
            showNotification("å¼€å§‹æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨HH:MMæ ¼å¼", "error");
            return;
          }
          if (!timeRegex.test(endTimeInput.value)) {
            showNotification("ç»“æŸæ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨HH:MMæ ¼å¼", "error");
            return;
          }

          // éªŒè¯å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´é€»è¾‘
          const startMinutes =
            parseInt(startTimeInput.value.split(":")[0]) * 60 +
            parseInt(startTimeInput.value.split(":")[1]);
          const endMinutes =
            parseInt(endTimeInput.value.split(":")[0]) * 60 +
            parseInt(endTimeInput.value.split(":")[1]);

          // éè·¨å¤©æƒ…å†µéªŒè¯
          if (
            endMinutes <= startMinutes &&
            !(startMinutes >= 22 * 60 && endMinutes <= 6 * 60)
          ) {
            showNotification("ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´", "error");
            return;
          }

          if (
            startTimeInput.value &&
            endTimeInput.value &&
            activityInput.value
          ) {
            if (editingScheduleId) {
              // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰æ—¶é—´æ®µ
              const scheduleIndex = userData.schedule.findIndex(
                (item) => item.id === editingScheduleId
              );
              if (scheduleIndex !== -1) {
                userData.schedule[scheduleIndex] = {
                  id: editingScheduleId,
                  startTime: normalizeTime(startTimeInput.value),
                  endTime: normalizeTime(endTimeInput.value),
                  activity: activityInput.value,
                };
                showNotification("æ—¶é—´æ®µå·²æ›´æ–°", "success");
                exitEditMode();
              }
            } else {
              // æ–°å¢æ¨¡å¼ï¼šæ·»åŠ æ–°æ—¶é—´æ®µ
              userData.schedule.push({
                id: nextScheduleId++,
                startTime: normalizeTime(startTimeInput.value),
                endTime: normalizeTime(endTimeInput.value),
                activity: activityInput.value,
              });
              showNotification("æ—¶é—´æ®µå·²æ·»åŠ ", "success");
            }

            // æ¸…ç©ºè¾“å…¥æ¡†
            startTimeInput.value = "";
            endTimeInput.value = "";
            activityInput.value = "";

            // æ›´æ–°é¢„è§ˆå’Œåˆ—è¡¨
            updatePreview();
            updateScheduleList();
          } else {
            showNotification("è¯·å¡«å†™å®Œæ•´çš„æ—¶é—´æ®µå’Œæ´»åŠ¨æè¿°", "error");
          }
        });

        /**
         * æ›´æ–°é¢„è§ˆåŠŸèƒ½
         * æ›´æ–°å£çº¸æ ‡é¢˜ã€å‰¯æ ‡é¢˜å’Œé¢„è§ˆå†…å®¹
         */
        const updatePreviewBtn = document.getElementById("updatePreviewBtn");
        updatePreviewBtn.addEventListener("click", function () {
          // æ›´æ–°æ ‡é¢˜
          const titleInput = document.getElementById("title");
          userData.title = titleInput.value || "æˆ‘çš„ä½œæ¯è¡¨";

          // æ›´æ–°å‰¯æ ‡é¢˜
          const subtitleInput = document.getElementById("subtitle");
          userData.subtitle = subtitleInput.value || "ä¿æŒè§„å¾‹ï¼Œæå‡æ•ˆç‡";

          // æ›´æ–°å‰¯æ ‡é¢˜æ˜¾ç¤ºçŠ¶æ€
          const hideSubtitleCheckbox = document.getElementById("hideSubtitle");
          userData.hideSubtitle = hideSubtitleCheckbox.checked;

          // æ›´æ–°é¢„è§ˆ
          updatePreview();

          // æ˜¾ç¤ºæˆåŠŸæç¤º
          showNotification("é¢„è§ˆå·²æ›´æ–°", "success");
        });

        /**
         * å‰¯æ ‡é¢˜å®æ—¶æ›´æ–°
         */
        const subtitleInput = document.getElementById("subtitle");
        const hideSubtitleCheckbox = document.getElementById("hideSubtitle");

        subtitleInput.addEventListener("input", function () {
          userData.subtitle = this.value || "ä¿æŒè§„å¾‹ï¼Œæå‡æ•ˆç‡";
          updatePreview();
        });

        hideSubtitleCheckbox.addEventListener("change", function () {
          userData.hideSubtitle = this.checked;
          updatePreview();
        });

        /**
         * å¸ƒå±€é€‰æ‹©åŠŸèƒ½
         * æ ¹æ®é€‰æ‹©çš„å¸ƒå±€æ˜¾ç¤ºç›¸åº”çš„é…ç½®é€‰é¡¹
         */
        const layoutRadios = document.querySelectorAll('input[name="layout"]');
        const tableLayoutConfig = document.getElementById("tableLayoutConfig");

        layoutRadios.forEach((radio) => {
          radio.addEventListener("change", function () {
            if (this.checked) {
              userData.layout = this.value;

              // æ˜¾ç¤º/éšè—è¡¨æ ¼é…ç½®
              if (this.value === "table") {
                tableLayoutConfig.classList.remove("hidden");
              } else {
                tableLayoutConfig.classList.add("hidden");
              }

              updatePreview();
            }
          });
        });

        /**
         * è¡¨æ ¼åˆ—æ•°é€‰æ‹©
         */
        const tableColumnRadios = document.querySelectorAll(
          'input[name="tableColumns"]'
        );
        tableColumnRadios.forEach((radio) => {
          radio.addEventListener("change", function () {
            if (this.checked) {
              userData.tableColumns = parseInt(this.value);
              if (userData.layout === "table") {
                updatePreview();
              }
            }
          });
        });

        // å­—ä½“å¤§å°è°ƒæ•´
        const fontSizeSlider = document.getElementById("fontSizeSlider");
        const fontSizeValue = document.getElementById("fontSizeValue");

        fontSizeSlider.addEventListener("input", function () {
          fontSizeValue.textContent = `${this.value}px`;
          userData.fontSize = parseInt(this.value);
          updatePreview();
        });

        // å­—ä½“é€‰æ‹©
        const fontSelect = document.getElementById("fontSelect");
        fontSelect.addEventListener("change", function () {
          userData.fontFamily = this.value;
          updatePreview();
        });

        // é¢œè‰²é€‰æ‹©
        const colorBtns = document.querySelectorAll(".color-btn");
        colorBtns.forEach((btn) => {
          btn.addEventListener("click", function () {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            colorBtns.forEach((b) => {
              b.classList.remove("ring-2");
            });

            // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
            this.classList.add("ring-2");

            // æ›´æ–°é¢œè‰²
            userData.bgColor = this.dataset.color;
            updatePreview();
          });
        });

        // é«˜çº§è®¾ç½®é¢æ¿åˆ‡æ¢
        const advancedSettingsBtn = document.getElementById(
          "advancedSettingsBtn"
        );
        const advancedSettingsPanel = document.getElementById(
          "advancedSettingsPanel"
        );

        advancedSettingsBtn.addEventListener("click", function () {
          advancedSettingsPanel.classList.toggle("hidden");
        });

        // é¢„è®¾æ¨¡æ¿
        const templateBtns = document.querySelectorAll(".template-btn");
        templateBtns.forEach((btn) => {
          btn.addEventListener("click", function () {
            const template = this.dataset.template;

            // åŠ è½½é¢„è®¾æ¨¡æ¿æ•°æ®
            loadTemplate(template);

            // æ›´æ–°é¢„è§ˆ
            updatePreview();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showNotification(`å·²åŠ è½½${this.textContent}æ¨¡æ¿`, "success");
          });
        });

        /**
         * æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
         * æ”¯æŒç‚¹å‡»é€‰æ‹©å’Œæ‹–æ‹½ä¸Šä¼ 
         */
        const fileUpload = document.getElementById("file-upload");
        const parseFileBtn = document.getElementById("parseFileBtn");
        const uploadArea = fileUpload.parentElement.parentElement;

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        fileUpload.addEventListener("change", function (e) {
          if (e.target.files.length > 0) {
            const file = e.target.files[0];
            validateAndShowFile(file);
          }
        });

        // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        uploadArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          uploadArea.classList.add("border-primary", "bg-blue-50");
        });

        uploadArea.addEventListener("dragleave", function (e) {
          e.preventDefault();
          uploadArea.classList.remove("border-primary", "bg-blue-50");
        });

        uploadArea.addEventListener("drop", function (e) {
          e.preventDefault();
          uploadArea.classList.remove("border-primary", "bg-blue-50");

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            const file = files[0];
            fileUpload.files = files; // è®¾ç½®æ–‡ä»¶åˆ°inputå…ƒç´ 
            validateAndShowFile(file);
          }
        });

        /**
         * éªŒè¯å¹¶æ˜¾ç¤ºé€‰æ‹©çš„æ–‡ä»¶
         * @param {File} file - é€‰æ‹©çš„æ–‡ä»¶
         */
        function validateAndShowFile(file) {
          const allowedExtensions = ["csv", "xlsx", "xls"];
          const fileExtension = file.name.split(".").pop().toLowerCase();

          if (!allowedExtensions.includes(fileExtension)) {
            showNotification(
              `ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${fileExtension}ï¼Œè¯·é€‰æ‹©CSVæˆ–Excelæ–‡ä»¶`,
              "error"
            );
            return;
          }

          if (file.size > 5 * 1024 * 1024) {
            // 5MBé™åˆ¶
            showNotification("æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB", "error");
            return;
          }

          showNotification(
            `å·²é€‰æ‹©æ–‡ä»¶: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`,
            "success"
          );
        }

        /**
         * æ–‡ä»¶è§£æåŠŸèƒ½
         * æ”¯æŒCSVæ ¼å¼çš„æ—¶é—´è¡¨å¯¼å…¥
         */
        parseFileBtn.addEventListener("click", function () {
          const fileInput = document.getElementById("file-upload");
          if (fileInput.files.length === 0) {
            showNotification("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶", "error");
            return;
          }

          const file = fileInput.files[0];
          const fileExtension = file.name.split(".").pop().toLowerCase();

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          parseFileBtn.innerHTML =
            '<div class="loading-spinner inline-block mr-2"></div> è§£æä¸­...';
          parseFileBtn.disabled = true;

          if (fileExtension === "csv") {
            // æ£€æŸ¥Papa Parseæ˜¯å¦å¯ç”¨
            if (typeof Papa === "undefined") {
              showNotification("CSVè§£æåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", "error");
              resetParseButton();
              return;
            }

            // ä½¿ç”¨Papa Parseè§£æCSVæ–‡ä»¶
            Papa.parse(file, {
              header: true,
              skipEmptyLines: true,
              encoding: "UTF-8",
              complete: function (results) {
                resetParseButton();

                if (results.errors.length > 0) {
                  console.error("CSVè§£æé”™è¯¯:", results.errors);
                  showNotification(
                    `CSVè§£æé”™è¯¯: ${results.errors[0].message}`,
                    "error"
                  );
                  return;
                }

                if (!results.data || results.data.length === 0) {
                  showNotification("CSVæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®", "error");
                  return;
                }

                // éªŒè¯CSVæ ¼å¼æ˜¯å¦åŒ…å«å¿…è¦çš„åˆ—
                const requiredColumns = ["startTime", "endTime", "activity"];
                const firstRow = results.data[0];
                const hasRequiredColumns = requiredColumns.every(
                  (col) => firstRow && firstRow.hasOwnProperty(col)
                );

                if (!hasRequiredColumns) {
                  showNotification(
                    "CSVæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œéœ€è¦åŒ…å«startTime, endTimeå’Œactivityåˆ—ã€‚è¯·ä¸‹è½½æ¨¡æ¿æ–‡ä»¶å‚è€ƒæ­£ç¡®æ ¼å¼ã€‚",
                    "error"
                  );
                  return;
                }

                // æ¸…ç©ºç°æœ‰æ•°æ®å¹¶æ·»åŠ è§£æåçš„æ•°æ®
                userData.schedule = [];
                let validCount = 0;
                const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;

                results.data.forEach((row, index) => {
                  // éªŒè¯æ—¶é—´æ ¼å¼
                  if (
                    !timeRegex.test(row.startTime) ||
                    !timeRegex.test(row.endTime)
                  ) {
                    showNotification(
                      `ç¬¬${index + 1}è¡Œæ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè·³è¿‡è¯¥è¡Œ`,
                      "warning"
                    );
                    return;
                  }

                  // éªŒè¯æ—¶é—´é€»è¾‘
                  const startMinutes =
                    parseInt(row.startTime.split(":")[0]) * 60 +
                    parseInt(row.startTime.split(":")[1]);
                  const endMinutes =
                    parseInt(row.endTime.split(":")[0]) * 60 +
                    parseInt(row.endTime.split(":")[1]);

                  if (
                    endMinutes <= startMinutes &&
                    !(startMinutes >= 22 * 60 && endMinutes <= 6 * 60)
                  ) {
                    showNotification(
                      `ç¬¬${index + 1}è¡Œç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´ï¼Œè·³è¿‡è¯¥è¡Œ`,
                      "warning"
                    );
                    return;
                  }

                  // éªŒè¯æ´»åŠ¨æè¿°
                  if (!row.activity || row.activity.trim() === "") {
                    showNotification(
                      `ç¬¬${index + 1}è¡Œæ´»åŠ¨æè¿°ä¸èƒ½ä¸ºç©ºï¼Œè·³è¿‡è¯¥è¡Œ`,
                      "warning"
                    );
                    return;
                  }

                  userData.schedule.push({
                    id: nextScheduleId++,
                    startTime: normalizeTime(row.startTime),
                    endTime: normalizeTime(row.endTime),
                    activity: row.activity,
                  });
                  validCount++;
                });

                updatePreview();
                updateScheduleList();
                showNotification(
                  `CSVæ–‡ä»¶è§£ææˆåŠŸï¼Œå…±å¯¼å…¥${validCount}ä¸ªæœ‰æ•ˆæ—¶é—´æ®µ`,
                  "success"
                );
              },
            });
          } else if (fileExtension === "xlsx" || fileExtension === "xls") {
            // æ£€æŸ¥SheetJSæ˜¯å¦å¯ç”¨
            if (typeof XLSX === "undefined") {
              showNotification("Excelè§£æåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", "error");
              resetParseButton();
              return;
            }

            // ä½¿ç”¨FileReaderè¯»å–Excelæ–‡ä»¶
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                // è§£æExcelæ–‡ä»¶
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });

                // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                  header: 1,
                  defval: "",
                });

                resetParseButton();

                if (!jsonData || jsonData.length === 0) {
                  showNotification("Excelæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®", "error");
                  return;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰æ ‡é¢˜è¡Œ
                if (jsonData.length < 2) {
                  showNotification(
                    "Excelæ–‡ä»¶è‡³å°‘éœ€è¦åŒ…å«æ ‡é¢˜è¡Œå’Œä¸€è¡Œæ•°æ®",
                    "error"
                  );
                  return;
                }

                // è·å–æ ‡é¢˜è¡Œ
                const headers = jsonData[0];
                const dataRows = jsonData.slice(1);

                // æŸ¥æ‰¾å¿…è¦çš„åˆ—ç´¢å¼•
                const startTimeIndex = headers.findIndex(
                  (h) =>
                    h &&
                    (h.toString().toLowerCase().includes("start") ||
                      h.toString().includes("å¼€å§‹") ||
                      h.toString().includes("startTime"))
                );
                const endTimeIndex = headers.findIndex(
                  (h) =>
                    h &&
                    (h.toString().toLowerCase().includes("end") ||
                      h.toString().includes("ç»“æŸ") ||
                      h.toString().includes("endTime"))
                );
                const activityIndex = headers.findIndex(
                  (h) =>
                    h &&
                    (h.toString().toLowerCase().includes("activity") ||
                      h.toString().includes("æ´»åŠ¨") ||
                      h.toString().includes("äº‹é¡¹") ||
                      h.toString().includes("å†…å®¹"))
                );

                if (
                  startTimeIndex === -1 ||
                  endTimeIndex === -1 ||
                  activityIndex === -1
                ) {
                  showNotification(
                    "Excelæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œéœ€è¦åŒ…å«å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´å’Œæ´»åŠ¨å†…å®¹åˆ—ã€‚è¯·ç¡®ä¿åˆ—æ ‡é¢˜åŒ…å«ç›¸å…³å…³é”®è¯ã€‚",
                    "error"
                  );
                  return;
                }

                // æ¸…ç©ºç°æœ‰æ•°æ®å¹¶æ·»åŠ è§£æåçš„æ•°æ®
                userData.schedule = [];
                let validCount = 0;
                const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;

                dataRows.forEach((row, index) => {
                  const startTime = row[startTimeIndex]?.toString().trim();
                  const endTime = row[endTimeIndex]?.toString().trim();
                  const activity = row[activityIndex]?.toString().trim();

                  // è·³è¿‡ç©ºè¡Œ
                  if (!startTime && !endTime && !activity) {
                    return;
                  }

                  // æ ‡å‡†åŒ–æ—¶é—´æ ¼å¼ï¼ˆå¤„ç†Excelå¯èƒ½çš„æ—¶é—´æ ¼å¼ï¼‰
                  let normalizedStartTime = normalizeExcelTime(startTime);
                  let normalizedEndTime = normalizeExcelTime(endTime);

                  // éªŒè¯æ—¶é—´æ ¼å¼
                  if (
                    !timeRegex.test(normalizedStartTime) ||
                    !timeRegex.test(normalizedEndTime)
                  ) {
                    showNotification(
                      `ç¬¬${
                        index + 2
                      }è¡Œæ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè·³è¿‡è¯¥è¡Œã€‚æ—¶é—´æ ¼å¼åº”ä¸º HH:MM`,
                      "warning"
                    );
                    return;
                  }

                  // éªŒè¯æ—¶é—´é€»è¾‘
                  const startMinutes =
                    parseInt(normalizedStartTime.split(":")[0]) * 60 +
                    parseInt(normalizedStartTime.split(":")[1]);
                  const endMinutes =
                    parseInt(normalizedEndTime.split(":")[0]) * 60 +
                    parseInt(normalizedEndTime.split(":")[1]);

                  if (
                    endMinutes <= startMinutes &&
                    !(startMinutes >= 22 * 60 && endMinutes <= 6 * 60)
                  ) {
                    showNotification(
                      `ç¬¬${index + 2}è¡Œç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´ï¼Œè·³è¿‡è¯¥è¡Œ`,
                      "warning"
                    );
                    return;
                  }

                  // éªŒè¯æ´»åŠ¨æè¿°
                  if (!activity) {
                    showNotification(
                      `ç¬¬${index + 2}è¡Œæ´»åŠ¨æè¿°ä¸èƒ½ä¸ºç©ºï¼Œè·³è¿‡è¯¥è¡Œ`,
                      "warning"
                    );
                    return;
                  }

                  userData.schedule.push({
                    id: nextScheduleId++,
                    startTime: normalizedStartTime,
                    endTime: normalizedEndTime,
                    activity: activity,
                  });
                  validCount++;
                });

                updatePreview();
                updateScheduleList();
                showNotification(
                  `Excelæ–‡ä»¶è§£ææˆåŠŸï¼Œå…±å¯¼å…¥${validCount}ä¸ªæœ‰æ•ˆæ—¶é—´æ®µ`,
                  "success"
                );
              } catch (error) {
                console.error("Excelè§£æé”™è¯¯:", error);
                showNotification(
                  `Excelæ–‡ä»¶è§£æå¤±è´¥: ${error.message}`,
                  "error"
                );
                resetParseButton();
              }
            };

            reader.onerror = function () {
              showNotification("æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•", "error");
              resetParseButton();
            };

            reader.readAsArrayBuffer(file);
          } else {
            resetParseButton();
            showNotification("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼ CSVæˆ–Excelæ–‡ä»¶", "error");
          }
        });

        /**
         * é‡ç½®è§£ææŒ‰é’®çŠ¶æ€
         */
        function resetParseButton() {
          parseFileBtn.innerHTML =
            '<i class="fa fa-refresh mr-1"></i> è§£ææ–‡ä»¶';
          parseFileBtn.disabled = false;
        }

        // åˆ†è¾¨ç‡é€‰æ‹©
        const resolutionSelect = document.getElementById("resolutionSelect");
        const customResolutionInputs = document.getElementById(
          "customResolutionInputs"
        );

        resolutionSelect.addEventListener("change", function () {
          userData.resolution = this.value;

          if (this.value === "custom") {
            customResolutionInputs.classList.remove("hidden");
          } else {
            customResolutionInputs.classList.add("hidden");

            // ä»åˆ†è¾¨ç‡å­—ç¬¦ä¸²ä¸­æå–å®½åº¦å’Œé«˜åº¦
            const [width, height] = this.value.split("x");
            userData.customWidth = parseInt(width);
            userData.customHeight = parseInt(height);
          }
        });

        // è‡ªå®šä¹‰åˆ†è¾¨ç‡è¾“å…¥
        const customWidthInput = document.getElementById("customWidth");
        const customHeightInput = document.getElementById("customHeight");

        customWidthInput.addEventListener("change", function () {
          const width = parseInt(this.value);
          if (isNaN(width) || width <= 0) {
            showNotification("å®½åº¦å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ­£æ•°", "error");
            this.value = userData.customWidth || 1920;
            return;
          }
          userData.customWidth = width;
        });

        customHeightInput.addEventListener("change", function () {
          const height = parseInt(this.value);
          if (isNaN(height) || height <= 0) {
            showNotification("é«˜åº¦å¿…é¡»æ˜¯æœ‰æ•ˆçš„æ­£æ•°", "error");
            this.value = userData.customHeight || 1080;
            return;
          }
          userData.customHeight = height;
        });

        // ä¸‹è½½å£çº¸åŠŸèƒ½
        const downloadBtn = document.getElementById("downloadBtn");
        downloadBtn.addEventListener("click", function () {
          const previewContainer = document.getElementById("wallpaperPreview");

          // è·å–é€‰æ‹©çš„åˆ†è¾¨ç‡
          let width, height;
          if (userData.resolution === "custom") {
            width = userData.customWidth;
            height = userData.customHeight;
          } else {
            [width, height] = userData.resolution.split("x").map(Number);
          }

          // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨ç”¨äºç”Ÿæˆé«˜åˆ†è¾¨ç‡å›¾åƒ
          const tempContainer = document.createElement("div");
          tempContainer.style.width = `${width}px`;
          tempContainer.style.height = `${height}px`;
          tempContainer.style.overflow = "hidden";
          tempContainer.style.position = "fixed";
          tempContainer.style.top = "-9999px";
          tempContainer.style.left = "-9999px";

          // å¤åˆ¶é¢„è§ˆå†…å®¹åˆ°ä¸´æ—¶å®¹å™¨
          const tempPreview = previewContainer.cloneNode(true);
          tempPreview.style.width = "100%";
          tempPreview.style.height = "100%";
          tempPreview.style.position = "relative";
          tempContainer.appendChild(tempPreview);

          // æ·»åŠ åˆ°é¡µé¢
          document.body.appendChild(tempContainer);

          // ä½¿ç”¨html2canvasæ•è·ä¸´æ—¶å®¹å™¨å¹¶åˆ›å»ºå›¾åƒ
          html2canvas(tempPreview, {
            scale: 2, // æé«˜ç¼©æ”¾æ¯”ä¾‹ä»¥è·å¾—æ›´é«˜è´¨é‡
            useCORS: true,
            logging: false,
            allowTaint: true,
            backgroundColor: null, // ä¿ç•™é€æ˜èƒŒæ™¯
          })
            .then((canvas) => {
              // å°†canvasè½¬æ¢ä¸ºBlob
              canvas.toBlob((blob) => {
                // ä¿å­˜ä¸ºPNGæ–‡ä»¶
                saveAs(blob, `${userData.title}.png`);

                // ç§»é™¤ä¸´æ—¶å®¹å™¨
                document.body.removeChild(tempContainer);
              });
            })
            .catch((error) => {
              console.error("ä¸‹è½½å£çº¸å¤±è´¥:", error);
              showNotification("ä¸‹è½½å£çº¸å¤±è´¥ï¼Œè¯·é‡è¯•", "error");

              // ç¡®ä¿ç§»é™¤ä¸´æ—¶å®¹å™¨
              document.body.removeChild(tempContainer);
            });
        });

        // åˆå§‹åŒ–è¡¨å•å€¼
        document.getElementById("title").value = userData.title;
        document.getElementById("subtitle").value = userData.subtitle;
        document.getElementById("hideSubtitle").checked = userData.hideSubtitle;

        /**
         * æ—¶é—´è¾“å…¥æ¡†æ ¼å¼æ ‡å‡†åŒ–
         * å½“ç”¨æˆ·è¾“å…¥æ—¶é—´åï¼Œè‡ªåŠ¨æ ‡å‡†åŒ–æ ¼å¼
         */
        const timeInputs = document.querySelectorAll(".start-time, .end-time");
        timeInputs.forEach((input) => {
          input.addEventListener("blur", function () {
            if (this.value) {
              this.value = normalizeTime(this.value);
            }
          });
        });

        // åˆå§‹åŒ–é¢„è§ˆå’Œåˆ—è¡¨
        updatePreview();
        updateScheduleList();
      });

      /**
       * æ›´æ–°æ—¶é—´æ®µåˆ—è¡¨æ˜¾ç¤º
       * æ˜¾ç¤ºæ‰€æœ‰å·²æ·»åŠ çš„æ—¶é—´æ®µï¼ŒåŒ…å«ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
       */
      function updateScheduleList() {
        const scheduleList = document.getElementById("scheduleList");
        const scheduleCount = document.getElementById("scheduleCount");

        // æ›´æ–°è®¡æ•°
        scheduleCount.textContent = `(${userData.schedule.length})`;

        // æ¸…ç©ºç°æœ‰åˆ—è¡¨
        scheduleList.innerHTML = "";

        if (userData.schedule.length === 0) {
          scheduleList.innerHTML =
            '<p class="text-gray-500 text-sm text-center py-4">æš‚æ— æ—¶é—´æ®µ</p>';
          return;
        }

        // æŒ‰å¼€å§‹æ—¶é—´æ’åº
        const sortedSchedule = sortScheduleByTime(userData.schedule);

        sortedSchedule.forEach((item) => {
          const scheduleItem = document.createElement("div");
          scheduleItem.className =
            "flex items-center justify-between p-3 bg-gray-50 rounded-lg border hover:bg-gray-100 transition-colors";

          scheduleItem.innerHTML = `
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium text-gray-900 truncate">
                ${item.startTime} - ${item.endTime}
              </div>
              <div class="text-sm text-gray-600 truncate">
                ${item.activity}
              </div>
            </div>
            <div class="flex space-x-1 ml-2">
              <button
                class="edit-schedule-btn p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded transition-colors"
                data-id="${item.id}"
                title="ç¼–è¾‘"
              >
                <i class="fa fa-edit text-xs"></i>
              </button>
              <button
                class="delete-schedule-btn p-1 text-red-600 hover:text-red-800 hover:bg-red-100 rounded transition-colors"
                data-id="${item.id}"
                title="åˆ é™¤"
              >
                <i class="fa fa-trash text-xs"></i>
              </button>
            </div>
          `;

          scheduleList.appendChild(scheduleItem);
        });

        // ç»‘å®šç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶
        bindScheduleListEvents();
      }

      /**
       * ç»‘å®šæ—¶é—´æ®µåˆ—è¡¨çš„ç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶
       */
      function bindScheduleListEvents() {
        // ç¼–è¾‘æŒ‰é’®äº‹ä»¶
        document.querySelectorAll(".edit-schedule-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const scheduleId = parseInt(this.dataset.id);
            editSchedule(scheduleId);
          });
        });

        // åˆ é™¤æŒ‰é’®äº‹ä»¶
        document.querySelectorAll(".delete-schedule-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const scheduleId = parseInt(this.dataset.id);
            deleteSchedule(scheduleId);
          });
        });
      }

      /**
       * ç¼–è¾‘æ—¶é—´æ®µ
       * @param {number} scheduleId - æ—¶é—´æ®µID
       */
      function editSchedule(scheduleId) {
        const schedule = userData.schedule.find(
          (item) => item.id === scheduleId
        );
        if (!schedule) return;

        // è¿›å…¥ç¼–è¾‘æ¨¡å¼
        editingScheduleId = scheduleId;

        // å¡«å……è¡¨å•
        document.querySelector(".start-time").value = schedule.startTime;
        document.querySelector(".end-time").value = schedule.endTime;
        document.querySelector(".activity").value = schedule.activity;

        // æ›´æ–°æŒ‰é’®æ–‡æœ¬
        const addTimeBtn = document.getElementById("addTimeBtn");
        addTimeBtn.innerHTML = '<i class="fa fa-save mr-1"></i> ä¿å­˜ä¿®æ”¹';
        addTimeBtn.classList.remove("bg-secondary");
        addTimeBtn.classList.add("bg-orange-500", "hover:bg-orange-600");

        // æ·»åŠ å–æ¶ˆæŒ‰é’®
        if (!document.getElementById("cancelEditBtn")) {
          const cancelBtn = document.createElement("button");
          cancelBtn.id = "cancelEditBtn";
          cancelBtn.className =
            "mt-2 w-full py-2 px-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors flex justify-center items-center";
          cancelBtn.innerHTML = '<i class="fa fa-times mr-1"></i> å–æ¶ˆç¼–è¾‘';
          cancelBtn.addEventListener("click", exitEditMode);
          addTimeBtn.parentNode.appendChild(cancelBtn);
        }

        showNotification("è¿›å…¥ç¼–è¾‘æ¨¡å¼", "info");
      }

      /**
       * é€€å‡ºç¼–è¾‘æ¨¡å¼
       */
      function exitEditMode() {
        editingScheduleId = null;

        // æ¸…ç©ºè¡¨å•
        document.querySelector(".start-time").value = "";
        document.querySelector(".end-time").value = "";
        document.querySelector(".activity").value = "";

        // æ¢å¤æŒ‰é’®
        const addTimeBtn = document.getElementById("addTimeBtn");
        addTimeBtn.innerHTML = '<i class="fa fa-plus mr-1"></i> æ·»åŠ æ—¶é—´æ®µ';
        addTimeBtn.classList.remove("bg-orange-500", "hover:bg-orange-600");
        addTimeBtn.classList.add("bg-secondary");

        // ç§»é™¤å–æ¶ˆæŒ‰é’®
        const cancelBtn = document.getElementById("cancelEditBtn");
        if (cancelBtn) {
          cancelBtn.remove();
        }
      }

      /**
       * åˆ é™¤æ—¶é—´æ®µ
       * @param {number} scheduleId - æ—¶é—´æ®µID
       */
      function deleteSchedule(scheduleId) {
        if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ—¶é—´æ®µå—ï¼Ÿ")) {
          userData.schedule = userData.schedule.filter(
            (item) => item.id !== scheduleId
          );
          updateScheduleList();
          updatePreview();
          showNotification("æ—¶é—´æ®µå·²åˆ é™¤", "success");

          // å¦‚æœæ­£åœ¨ç¼–è¾‘è¢«åˆ é™¤çš„æ—¶é—´æ®µï¼Œé€€å‡ºç¼–è¾‘æ¨¡å¼
          if (editingScheduleId === scheduleId) {
            exitEditMode();
          }
        }
      }

      /**
       * æ›´æ–°é¢„è§ˆåŒºåŸŸ
       * æ›´æ–°æ ‡é¢˜ã€å‰¯æ ‡é¢˜å’Œå¸ƒå±€å†…å®¹
       */
      function updatePreview() {
        const previewElement = document.getElementById("wallpaperPreview");
        const titleElement = document.getElementById("previewTitle");
        const subtitleElement = document.getElementById("previewSubtitle");
        const scheduleContainer = document.getElementById("scheduleContainer");

        // æ›´æ–°æ ‡é¢˜ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤æ ‡é¢˜
        titleElement.textContent = userData.title || "æˆ‘çš„ä½œæ¯è¡¨";

        // æ›´æ–°å‰¯æ ‡é¢˜
        if (userData.hideSubtitle) {
          subtitleElement.style.display = "none";
        } else {
          subtitleElement.style.display = "block";
          subtitleElement.textContent =
            userData.subtitle || "ä¿æŒè§„å¾‹ï¼Œæå‡æ•ˆç‡";
        }

        // æ›´æ–°ä¸»é¢˜
        updateTheme();

        // æ¸…ç©ºç°æœ‰æ—¶é—´æ®µ
        scheduleContainer.innerHTML = "";

        // æ ¹æ®å¸ƒå±€ç±»å‹ç”Ÿæˆå†…å®¹
        if (userData.layout === "time-block") {
          generateTimeBlockLayout(scheduleContainer);
        } else if (userData.layout === "timeline") {
          generateTimelineLayout(scheduleContainer);
        } else if (userData.layout === "grid") {
          generateGridLayout(scheduleContainer);
        } else if (userData.layout === "table") {
          generateTableLayout(scheduleContainer);
        }

        // æ›´æ–°å­—ä½“
        previewElement.style.fontFamily = userData.fontFamily;
        previewElement.style.fontSize = `${userData.fontSize}px`;
      }

      /**
       * æ›´æ–°èƒŒæ™¯é¢œè‰²
       * æ ¹æ®ç”¨æˆ·é€‰æ‹©åº”ç”¨èƒŒæ™¯é¢œè‰²æˆ–é»˜è®¤æ¸å˜
       */
      function updateTheme() {
        const previewElement = document.getElementById("wallpaperPreview");

        // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„èƒŒæ™¯ç±»
        const backgroundClasses = [
          "wallpaper-preview",
          "bg-gradient-to-br",
          "from-blue-400",
          "to-indigo-500",
          "bg-blue-500",
          "bg-green-500",
          "bg-purple-500",
          "bg-yellow-500",
          "bg-red-500",
          "bg-indigo-500",
          "bg-teal-500",
          "bg-pink-500",
          "bg-orange-500",
          "bg-gray-800",
          "bg-white",
        ];

        previewElement.classList.remove(...backgroundClasses);

        // å¦‚æœèƒŒæ™¯é¢œè‰²ä¸æ˜¯é€æ˜ï¼Œä½¿ç”¨é€‰æ‹©çš„èƒŒæ™¯é¢œè‰²
        if (userData.bgColor !== "transparent") {
          previewElement.classList.add(`bg-${userData.bgColor}`);
        } else {
          // ä½¿ç”¨é»˜è®¤æ¸å˜èƒŒæ™¯
          previewElement.classList.add(
            "wallpaper-preview",
            "bg-gradient-to-br",
            "from-blue-400",
            "to-indigo-500"
          );
        }
      }

      /**
       * ç”Ÿæˆæ—¶é—´å—å¸ƒå±€
       * æ¢å¤åŸå§‹çš„ç®€æ´å¡ç‰‡é£æ ¼
       */
      function generateTimeBlockLayout(container) {
        // è®¾ç½®å®¹å™¨ä¸ºç½‘æ ¼å¸ƒå±€
        container.className = "grid grid-cols-2 gap-4 h-full";

        // æŒ‰å¼€å§‹æ—¶é—´æ’åº
        const sortedSchedule = sortScheduleByTime(userData.schedule);

        if (sortedSchedule.length === 0) {
          container.innerHTML = `
            <div class="col-span-2 flex items-center justify-center h-full">
              <div class="text-center text-gray-500">
                <i class="fa fa-calendar-o text-4xl mb-4"></i>
                <p>æš‚æ— æ—¶é—´å®‰æ’</p>
                <p class="text-sm">è¯·æ·»åŠ æ—¶é—´æ®µæ¥ç”Ÿæˆæ—¶é—´å—</p>
              </div>
            </div>
          `;
          return;
        }

        sortedSchedule.forEach((item, index) => {
          // åˆ›å»ºæ—¶é—´æ®µå…ƒç´ 
          const timeBlock = document.createElement("div");
          timeBlock.className =
            "time-block-card rounded-lg p-4 shadow-md border border-white/50 transition-transform hover:scale-[1.02]";

          // æ ¹æ®æ—¶é—´æ®µåœ¨ä¸€å¤©ä¸­çš„ä½ç½®è®¾ç½®ä¸åŒçš„é¢œè‰²
          const startTimeHours = parseInt(item.startTime.split(":")[0]);
          let bgColorClass = "bg-white/80";
          let borderColorClass = "border-blue-200";
          let textColorClass = "text-gray-800";

          if (startTimeHours >= 5 && startTimeHours < 12) {
            bgColorClass = "bg-yellow-50/90"; // æ—©æ™¨
            borderColorClass = "border-yellow-200";
          } else if (startTimeHours >= 12 && startTimeHours < 18) {
            bgColorClass = "bg-blue-50/90"; // ä¸‹åˆ
            borderColorClass = "border-blue-200";
          } else if (startTimeHours >= 18 && startTimeHours < 22) {
            bgColorClass = "bg-purple-50/90"; // æ™šä¸Š
            borderColorClass = "border-purple-200";
          } else {
            bgColorClass = "bg-gray-50/90"; // æ·±å¤œ
            borderColorClass = "border-gray-200";
            textColorClass = "text-gray-700";
          }

          timeBlock.classList.add(bgColorClass, borderColorClass);

          // è®¾ç½®å†…å®¹
          timeBlock.innerHTML = `
            <div class="font-medium ${textColorClass} text-sm mb-1">${item.startTime} - ${item.endTime}</div>
            <div class="font-bold text-base ${textColorClass}">${item.activity}</div>
          `;

          container.appendChild(timeBlock);
        });
      }

      /**
       * ç”Ÿæˆæ—¶é—´è½´å¸ƒå±€
       * ä»¥æ—¶é—´çº¿å½¢å¼å±•ç¤ºæ—¶é—´å®‰æ’ï¼Œæ”¯æŒæ»šåŠ¨æŸ¥çœ‹æ‰€æœ‰å†…å®¹
       */
      function generateTimelineLayout(container) {
        // è®¾ç½®å®¹å™¨æ ·å¼ï¼Œç¡®ä¿å¯ä»¥æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
        container.className = "w-full h-full overflow-y-auto px-4";

        // åˆ›å»ºæ—¶é—´è½´å®¹å™¨
        const timelineContainer = document.createElement("div");
        timelineContainer.className =
          "timeline-container space-y-4 text-gray-800 py-4";

        // æŒ‰å¼€å§‹æ—¶é—´æ’åº
        const sortedSchedule = sortScheduleByTime(userData.schedule);

        if (sortedSchedule.length === 0) {
          container.innerHTML = `
            <div class="flex items-center justify-center h-full">
              <div class="text-center text-gray-500">
                <i class="fa fa-clock-o text-4xl mb-4"></i>
                <p>æš‚æ— æ—¶é—´å®‰æ’</p>
                <p class="text-sm">è¯·æ·»åŠ æ—¶é—´æ®µæ¥ç”Ÿæˆæ—¶é—´è½´</p>
              </div>
            </div>
          `;
          return;
        }

        sortedSchedule.forEach((item, index) => {
          // åˆ›å»ºæ—¶é—´è½´é¡¹ç›®
          const timelineItem = document.createElement("div");
          timelineItem.className = "timeline-item relative";

          // è®¾ç½®æ—¶é—´è½´é¡¹ç›®é¢œè‰²
          const colorClass = getTimelineColor(index);
          timelineItem.classList.add(colorClass);

          // è®¡ç®—æŒç»­æ—¶é—´
          const startParts = item.startTime.split(":");
          const endParts = item.endTime.split(":");
          const startMinutes =
            parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
          let endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);

          if (endMinutes < startMinutes) {
            endMinutes += 24 * 60;
          }

          const durationMinutes = endMinutes - startMinutes;
          const hours = Math.floor(durationMinutes / 60);
          const minutes = durationMinutes % 60;
          const durationText =
            hours > 0
              ? `${hours}å°æ—¶${minutes > 0 ? minutes + "åˆ†é’Ÿ" : ""}`
              : `${minutes}åˆ†é’Ÿ`;

          // è®¾ç½®å†…å®¹
          timelineItem.innerHTML = `
            <div class="timeline-dot"></div>
            <div class="ml-6 bg-white/80 backdrop-blur-sm rounded-lg p-4 shadow-sm border border-gray-200">
              <div class="flex justify-between items-start mb-2">
                <div class="font-bold text-lg text-gray-900">${item.activity}</div>
                <div class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">${durationText}</div>
              </div>
              <div class="font-medium text-gray-700">${item.startTime} - ${item.endTime}</div>
            </div>
          `;

          timelineContainer.appendChild(timelineItem);
        });

        container.appendChild(timelineContainer);
      }

      // ä¸ºæ—¶é—´è½´é¡¹ç›®è·å–é¢œè‰²
      function getTimelineColor(index) {
        const colors = [
          "text-blue-500",
          "text-green-500",
          "text-purple-500",
          "text-yellow-500",
          "text-red-500",
        ];
        return colors[index % colors.length];
      }

      // ç”Ÿæˆç½‘æ ¼å¸ƒå±€
      function generateGridLayout(container) {
        // è®¾ç½®ç½‘æ ¼åˆ—æ•°
        const cols = 4;
        container.className = "grid grid-cols-4 gap-2 h-full";

        // æŒ‰å¼€å§‹æ—¶é—´æ’åº
        const sortedSchedule = sortScheduleByTime(userData.schedule);

        sortedSchedule.forEach((item, index) => {
          // åˆ›å»ºç½‘æ ¼é¡¹ç›®
          const gridItem = document.createElement("div");

          // è®¾ç½®èƒŒæ™¯é¢œè‰²
          const colorClass = getGridColor(index);
          gridItem.className = `rounded-lg p-3 shadow-md ${colorClass} text-white transition-transform hover:scale-[1.03]`;

          // è®¾ç½®å†…å®¹
          gridItem.innerHTML = `
                    <div class="font-medium text-sm">${item.startTime} - ${item.endTime}</div>
                    <div class="font-bold text-lg mt-1">${item.activity}</div>
                `;

          container.appendChild(gridItem);
        });
      }

      // ä¸ºç½‘æ ¼é¡¹ç›®è·å–é¢œè‰²
      function getGridColor(index) {
        const colors = [
          "bg-blue-500",
          "bg-green-500",
          "bg-purple-500",
          "bg-yellow-500",
          "bg-red-500",
          "bg-indigo-500",
          "bg-teal-500",
          "bg-amber-500",
        ];
        return colors[index % colors.length];
      }

      /**
       * ç”Ÿæˆè¡¨æ ¼å¸ƒå±€
       * æ”¯æŒå•åˆ—å’ŒåŒåˆ—è¡¨æ ¼å±•ç¤º
       */
      function generateTableLayout(container) {
        // è®¾ç½®å®¹å™¨ä¸ºè¡¨æ ¼å¸ƒå±€
        container.className = "w-full h-full overflow-auto";

        // æŒ‰å¼€å§‹æ—¶é—´æ’åº
        const sortedSchedule = sortScheduleByTime(userData.schedule);

        if (sortedSchedule.length === 0) {
          container.innerHTML = `
            <div class="flex items-center justify-center h-full">
              <div class="text-center text-gray-500">
                <i class="fa fa-table text-4xl mb-4"></i>
                <p>æš‚æ— æ—¶é—´å®‰æ’</p>
                <p class="text-sm">è¯·æ·»åŠ æ—¶é—´æ®µæ¥ç”Ÿæˆè¡¨æ ¼</p>
              </div>
            </div>
          `;
          return;
        }

        // åˆ›å»ºè¡¨æ ¼
        const table = document.createElement("table");
        table.className =
          "w-full border-collapse bg-white/90 backdrop-blur-sm rounded-lg overflow-hidden shadow-lg";

        // æ ¹æ®åˆ—æ•°é…ç½®åˆ›å»ºè¡¨å¤´
        const thead = document.createElement("thead");
        if (userData.tableColumns === 1) {
          // å•åˆ—è¡¨æ ¼
          thead.innerHTML = `
            <tr class="bg-gray-800 text-white">
              <th class="px-4 py-3 text-left font-semibold">æ—¶é—´å®‰æ’</th>
            </tr>
          `;
        } else {
          // åŒåˆ—è¡¨æ ¼
          thead.innerHTML = `
            <tr class="bg-gray-800 text-white">
              <th class="px-4 py-3 text-left font-semibold border-r border-gray-600">æ—¶é—´</th>
              <th class="px-4 py-3 text-left font-semibold">æ´»åŠ¨å®‰æ’</th>
            </tr>
          `;
        }
        table.appendChild(thead);

        // åˆ›å»ºè¡¨ä½“
        const tbody = document.createElement("tbody");

        sortedSchedule.forEach((item, index) => {
          const row = document.createElement("tr");
          row.className = `border-b border-gray-200 hover:bg-gray-50 transition-colors ${
            index % 2 === 0 ? "bg-white" : "bg-gray-50"
          }`;

          // è®¡ç®—æ—¶é—´æ®µæŒç»­æ—¶é—´
          const startParts = item.startTime.split(":");
          const endParts = item.endTime.split(":");
          const startMinutes =
            parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
          let endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);

          // å¤„ç†è·¨å¤©æƒ…å†µ
          if (endMinutes < startMinutes) {
            endMinutes += 24 * 60;
          }

          const durationMinutes = endMinutes - startMinutes;
          const hours = Math.floor(durationMinutes / 60);
          const minutes = durationMinutes % 60;
          const durationText =
            hours > 0
              ? `${hours}å°æ—¶${minutes > 0 ? minutes + "åˆ†é’Ÿ" : ""}`
              : `${minutes}åˆ†é’Ÿ`;

          // æ ¹æ®åˆ—æ•°é…ç½®ç”Ÿæˆä¸åŒçš„è¡Œå†…å®¹
          if (userData.tableColumns === 1) {
            // å•åˆ—è¡¨æ ¼ï¼šæ—¶é—´å’Œæ´»åŠ¨åœ¨åŒä¸€åˆ—
            row.innerHTML = `
              <td class="px-4 py-3">
                <div class="flex flex-col space-y-1">
                  <div class="font-bold text-lg text-gray-900">${item.activity}</div>
                  <div class="font-medium text-gray-700">${item.startTime} - ${item.endTime}</div>
                  <div class="text-sm text-gray-500">${durationText}</div>
                </div>
              </td>
            `;
          } else {
            // åŒåˆ—è¡¨æ ¼ï¼šæ—¶é—´å’Œæ´»åŠ¨åˆ†å¼€
            row.innerHTML = `
              <td class="px-4 py-3 border-r border-gray-200">
                <div class="font-medium text-gray-900">${item.startTime} - ${item.endTime}</div>
                <div class="text-sm text-gray-500">${durationText}</div>
              </td>
              <td class="px-4 py-3">
                <div class="font-medium text-gray-900">${item.activity}</div>
              </td>
            `;
          }

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        container.appendChild(table);

        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
        if (sortedSchedule.length === 0) {
          container.innerHTML = `
            <div class="flex items-center justify-center h-full">
              <div class="text-center text-gray-500">
                <i class="fa fa-calendar-o text-4xl mb-4"></i>
                <p>æš‚æ— æ—¶é—´å®‰æ’</p>
                <p class="text-sm">è¯·æ·»åŠ æ—¶é—´æ®µæ¥ç”Ÿæˆè¡¨æ ¼</p>
              </div>
            </div>
          `;
        }
      }

      /**
       * åŠ è½½é¢„è®¾æ¨¡æ¿
       * @param {string} template - æ¨¡æ¿ç±»å‹
       */
      function loadTemplate(template) {
        // æ¸…ç©ºç°æœ‰æ•°æ®
        userData.schedule = [];
        nextScheduleId = 1;

        if (template === "student") {
          userData.title = "å­¦ç”Ÿæ—¥å¸¸ä½œæ¯";
          userData.schedule = [
            {
              id: nextScheduleId++,
              startTime: "06:30",
              endTime: "07:30",
              activity: "èµ·åºŠ & æ—©é¤",
            },
            {
              id: nextScheduleId++,
              startTime: "07:30",
              endTime: "08:00",
              activity: "å‰å¾€å­¦æ ¡",
            },
            {
              id: nextScheduleId++,
              startTime: "08:00",
              endTime: "12:00",
              activity: "ä¸Šåˆè¯¾ç¨‹",
            },
            {
              id: nextScheduleId++,
              startTime: "12:00",
              endTime: "13:00",
              activity: "åˆé¤ & ä¼‘æ¯",
            },
            {
              id: nextScheduleId++,
              startTime: "13:00",
              endTime: "17:00",
              activity: "ä¸‹åˆè¯¾ç¨‹",
            },
            {
              id: nextScheduleId++,
              startTime: "17:00",
              endTime: "18:00",
              activity: "è¯¾å¤–æ´»åŠ¨",
            },
            {
              id: nextScheduleId++,
              startTime: "18:00",
              endTime: "19:00",
              activity: "æ™šé¤",
            },
            {
              id: nextScheduleId++,
              startTime: "19:00",
              endTime: "21:00",
              activity: "å®¶åº­ä½œä¸š",
            },
            {
              id: nextScheduleId++,
              startTime: "21:00",
              endTime: "22:00",
              activity: "è‡ªç”±æ—¶é—´",
            },
            {
              id: nextScheduleId++,
              startTime: "22:00",
              endTime: "23:00",
              activity: "æ´—æ¼± & å‡†å¤‡ç¡è§‰",
            },
            {
              id: nextScheduleId++,
              startTime: "23:00",
              endTime: "06:30",
              activity: "ç¡çœ ",
            },
          ];
        } else if (template === "office") {
          userData.title = "èŒåœºç™½é¢†ä½œæ¯";
          userData.schedule = [
            {
              id: nextScheduleId++,
              startTime: "07:00",
              endTime: "08:00",
              activity: "èµ·åºŠ & æ—©é¤",
            },
            {
              id: nextScheduleId++,
              startTime: "08:00",
              endTime: "09:00",
              activity: "é€šå‹¤",
            },
            {
              id: nextScheduleId++,
              startTime: "09:00",
              endTime: "12:00",
              activity: "ä¸Šåˆå·¥ä½œ",
            },
            {
              id: nextScheduleId++,
              startTime: "12:00",
              endTime: "13:00",
              activity: "åˆé¤ & ä¼‘æ¯",
            },
            {
              id: nextScheduleId++,
              startTime: "13:00",
              endTime: "18:00",
              activity: "ä¸‹åˆå·¥ä½œ",
            },
            {
              id: nextScheduleId++,
              startTime: "18:00",
              endTime: "19:00",
              activity: "é€šå‹¤",
            },
            {
              id: nextScheduleId++,
              startTime: "19:00",
              endTime: "20:00",
              activity: "æ™šé¤",
            },
            {
              id: nextScheduleId++,
              startTime: "20:00",
              endTime: "21:30",
              activity: "ä¼‘é—²/è¿åŠ¨",
            },
            {
              id: nextScheduleId++,
              startTime: "21:30",
              endTime: "23:00",
              activity: "è‡ªç”±æ—¶é—´",
            },
            {
              id: nextScheduleId++,
              startTime: "23:00",
              endTime: "07:00",
              activity: "ç¡çœ ",
            },
          ];
        } else if (template === "freelancer") {
          userData.title = "è‡ªç”±èŒä¸šè€…ä½œæ¯";
          userData.schedule = [
            {
              id: nextScheduleId++,
              startTime: "08:00",
              endTime: "09:00",
              activity: "èµ·åºŠ & æ—©é¤",
            },
            {
              id: nextScheduleId++,
              startTime: "09:00",
              endTime: "11:00",
              activity: "å·¥ä½œ",
            },
            {
              id: nextScheduleId++,
              startTime: "11:00",
              endTime: "11:15",
              activity: "ä¼‘æ¯",
            },
            {
              id: nextScheduleId++,
              startTime: "11:15",
              endTime: "13:00",
              activity: "å·¥ä½œ",
            },
            {
              id: nextScheduleId++,
              startTime: "13:00",
              endTime: "14:00",
              activity: "åˆé¤ & ä¼‘æ¯",
            },
            {
              id: nextScheduleId++,
              startTime: "14:00",
              endTime: "17:00",
              activity: "å·¥ä½œ",
            },
            {
              id: nextScheduleId++,
              startTime: "17:00",
              endTime: "18:00",
              activity: "è¿åŠ¨",
            },
            {
              id: nextScheduleId++,
              startTime: "18:00",
              endTime: "19:00",
              activity: "æ™šé¤",
            },
            {
              id: nextScheduleId++,
              startTime: "19:00",
              endTime: "21:00",
              activity: "è‡ªç”±æ—¶é—´",
            },
            {
              id: nextScheduleId++,
              startTime: "21:00",
              endTime: "23:00",
              activity: "å·¥ä½œ/å­¦ä¹ ",
            },
            {
              id: nextScheduleId++,
              startTime: "23:00",
              endTime: "08:00",
              activity: "ç¡çœ ",
            },
          ];
        } else if (template === "fitness") {
          userData.title = "å¥èº«è®¡åˆ’ä½œæ¯";
          userData.schedule = [
            {
              id: nextScheduleId++,
              startTime: "06:00",
              endTime: "07:00",
              activity: "èµ·åºŠ & æ™¨ç»ƒ",
            },
            {
              id: nextScheduleId++,
              startTime: "07:00",
              endTime: "08:00",
              activity: "æ—©é¤ & å‡†å¤‡",
            },
            {
              id: nextScheduleId++,
              startTime: "08:00",
              endTime: "12:00",
              activity: "å·¥ä½œ/å­¦ä¹ ",
            },
            {
              id: nextScheduleId++,
              startTime: "12:00",
              endTime: "13:30",
              activity: "åˆé¤ & ä¼‘æ¯",
            },
            {
              id: nextScheduleId++,
              startTime: "13:30",
              endTime: "17:30",
              activity: "å·¥ä½œ/å­¦ä¹ ",
            },
            {
              id: nextScheduleId++,
              startTime: "17:30",
              endTime: "19:00",
              activity: "å¥èº«è®­ç»ƒ",
            },
            {
              id: nextScheduleId++,
              startTime: "19:00",
              endTime: "20:00",
              activity: "æ™šé¤",
            },
            {
              id: nextScheduleId++,
              startTime: "20:00",
              endTime: "21:00",
              activity: "æ‹‰ä¼¸/æ”¾æ¾",
            },
            {
              id: nextScheduleId++,
              startTime: "21:00",
              endTime: "22:30",
              activity: "è‡ªç”±æ—¶é—´",
            },
            {
              id: nextScheduleId++,
              startTime: "22:30",
              endTime: "06:00",
              activity: "ç¡çœ ",
            },
          ];
        }

        // æ›´æ–°åˆ—è¡¨æ˜¾ç¤º
        updateScheduleList();
      }

      // æ˜¾ç¤ºé€šçŸ¥
      function showNotification(message, type = "info") {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement("div");

        // è®¾ç½®æ ·å¼
        let bgColor, textColor, icon;
        if (type === "success") {
          bgColor = "bg-green-500";
          textColor = "text-white";
          icon = "fa-check-circle";
        } else if (type === "error") {
          bgColor = "bg-red-500";
          textColor = "text-white";
          icon = "fa-exclamation-circle";
        } else if (type === "warning") {
          bgColor = "bg-yellow-500";
          textColor = "text-white";
          icon = "fa-exclamation-triangle";
        } else {
          bgColor = "bg-blue-500";
          textColor = "text-white";
          icon = "fa-info-circle";
        }

        notification.className = `${bgColor} ${textColor} py-3 px-4 rounded-lg shadow-lg fixed bottom-4 right-4 z-50 transform transition-all duration-300 translate-y-20 opacity-0 flex items-center`;

        // è®¾ç½®å†…å®¹
        notification.innerHTML = `
                <i class="fa ${icon} mr-2"></i>
                <span>${message}</span>
            `;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(notification);

        // æ˜¾ç¤ºé€šçŸ¥
        setTimeout(() => {
          notification.classList.remove("translate-y-20", "opacity-0");
        }, 100);

        // 3ç§’åéšè—é€šçŸ¥
        setTimeout(() => {
          notification.classList.add("translate-y-20", "opacity-0");

          // å®Œå…¨éšè—åç§»é™¤å…ƒç´ 
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      // èƒŒæ™¯å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·è‡ªå®šä¹‰å£çº¸èƒŒæ™¯
      const bgImageUpload = document.getElementById("bgImageUpload");
      bgImageUpload.addEventListener("change", function (e) {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          const reader = new FileReader();

          reader.onload = function (event) {
            const wallpaperPreview =
              document.getElementById("wallpaperPreview");
            wallpaperPreview.style.backgroundImage = `url(${event.target.result})`;
            wallpaperPreview.style.backgroundSize = "cover";
            wallpaperPreview.style.backgroundPosition = "center";
            showNotification("èƒŒæ™¯å›¾ç‰‡å·²æ·»åŠ ", "success");
          };

          reader.readAsDataURL(file);
        }
      });

      // é¢œè‰²é€‰æ‹©åŠŸèƒ½
      const colorButtons = document.querySelectorAll(".color-btn");
      colorButtons.forEach((button) => {
        button.addEventListener("click", function () {
          // ç§»é™¤æ‰€æœ‰é¢œè‰²æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
          colorButtons.forEach((btn) =>
            btn.classList.remove("ring-2", "ring-offset-2")
          );
          // æ·»åŠ å½“å‰é€‰ä¸­æŒ‰é’®çš„çŠ¶æ€
          this.classList.add("ring-2", "ring-offset-2");
          // æ›´æ–°ç”¨æˆ·æ•°æ®
          userData.bgColor = this.dataset.color;
          // æ›´æ–°é¢„è§ˆ
          updatePreview();
          showNotification("èƒŒæ™¯é¢œè‰²å·²æ›´æ–°", "success");
        });
      });

      // å…¨å±é¢„è§ˆåŠŸèƒ½
      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const wallpaperPreview = document.getElementById("wallpaperPreview");

      fullscreenBtn.addEventListener("click", function () {
        if (!document.fullscreenElement) {
          wallpaperPreview.requestFullscreen().catch((err) => {
            showNotification(`å…¨å±è¯·æ±‚å¤±è´¥: ${err.message}`, "error");
          });
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      });

      // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°æŒ‰é’®å›¾æ ‡
      document.addEventListener("fullscreenchange", function () {
        if (document.fullscreenElement) {
          fullscreenBtn.innerHTML =
            '<i class="fa fa-compress mr-2"></i> é€€å‡ºå…¨å±';
        } else {
          fullscreenBtn.innerHTML =
            '<i class="fa fa-expand mr-2"></i> å…¨å±é¢„è§ˆ';
        }
      });

      // ä¸‹è½½æ¨¡æ¿åŠŸèƒ½ï¼ˆæ”¯æŒCSVå’ŒExcelæ ¼å¼ï¼‰
      document
        .getElementById("downloadTemplateBtn")
        .addEventListener("click", function () {
          // æ˜¾ç¤ºæ ¼å¼é€‰æ‹©å¯¹è¯æ¡†
          const format = confirm(
            "é€‰æ‹©ä¸‹è½½æ ¼å¼ï¼š\nç¡®å®š = Excelæ ¼å¼ (.xlsx)\nå–æ¶ˆ = CSVæ ¼å¼ (.csv)"
          );

          if (format) {
            // ä¸‹è½½Excelæ¨¡æ¿
            downloadExcelTemplate();
          } else {
            // ä¸‹è½½CSVæ¨¡æ¿
            downloadCSVTemplate();
          }
        });

      /**
       * ä¸‹è½½CSVæ¨¡æ¿æ–‡ä»¶
       */
      function downloadCSVTemplate() {
        // CSVæ¨¡æ¿å†…å®¹
        const csvContent = `startTime,endTime,activity
07:00,08:00,èµ·åºŠ & æ—©é¤
08:00,12:00,ä¸Šåˆå·¥ä½œ
12:00,13:00,åˆé¤ä¼‘æ¯
13:00,18:00,ä¸‹åˆå·¥ä½œ
18:00,19:00,æ™šé¤
19:00,21:00,ä¼‘é—²æ—¶é—´
21:00,22:00,å­¦ä¹ å……ç”µ
22:00,23:00,å‡†å¤‡ç¡è§‰
23:00,07:00,ç¡çœ `;

        // åˆ›å»ºBlobå¯¹è±¡
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);

        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const a = document.createElement("a");
        a.href = url;
        a.download = "schedule_template.csv";
        document.body.appendChild(a);

        // è§¦å‘ä¸‹è½½
        a.click();

        // æ¸…ç†
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // æ˜¾ç¤ºé€šçŸ¥
        showNotification("CSVæ¨¡æ¿å·²æˆåŠŸä¸‹è½½", "success");
      }

      /**
       * ä¸‹è½½Excelæ¨¡æ¿æ–‡ä»¶
       */
      function downloadExcelTemplate() {
        // æ£€æŸ¥SheetJSæ˜¯å¦å¯ç”¨
        if (typeof XLSX === "undefined") {
          showNotification("Excelåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", "error");
          return;
        }

        try {
          // åˆ›å»ºæ¨¡æ¿æ•°æ®
          const templateData = [
            ["startTime", "endTime", "activity"],
            ["07:00", "08:00", "èµ·åºŠ & æ—©é¤"],
            ["08:00", "12:00", "ä¸Šåˆå·¥ä½œ"],
            ["12:00", "13:00", "åˆé¤ä¼‘æ¯"],
            ["13:00", "18:00", "ä¸‹åˆå·¥ä½œ"],
            ["18:00", "19:00", "æ™šé¤"],
            ["19:00", "21:00", "ä¼‘é—²æ—¶é—´"],
            ["21:00", "22:00", "å­¦ä¹ å……ç”µ"],
            ["22:00", "23:00", "å‡†å¤‡ç¡è§‰"],
            ["23:00", "07:00", "ç¡çœ "],
          ];

          // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(templateData);

          // è®¾ç½®åˆ—å®½
          ws["!cols"] = [
            { wch: 12 }, // startTimeåˆ—
            { wch: 12 }, // endTimeåˆ—
            { wch: 20 }, // activityåˆ—
          ];

          // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
          XLSX.utils.book_append_sheet(wb, ws, "ä½œæ¯æ—¶é—´è¡¨");

          // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
          XLSX.writeFile(wb, "schedule_template.xlsx");

          // æ˜¾ç¤ºé€šçŸ¥
          showNotification("Excelæ¨¡æ¿å·²æˆåŠŸä¸‹è½½", "success");
        } catch (error) {
          console.error("Excelæ¨¡æ¿ç”Ÿæˆå¤±è´¥:", error);
          showNotification("Excelæ¨¡æ¿ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•", "error");
        }
      }

      // åˆå§‹åŒ–é¢„è§ˆ
      updatePreview();
    </script>
  </body>
</html>
